<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM - Panel de BI y Supervisión</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #8b5cf6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden">
  
  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } = window.Recharts;

    const firebaseConfig = {
      apiKey: "AIzaSyAAETou6DhYIJJ8cxI13BU1p_l3yGPMilA",
      authDomain: "ventas-ebd49.firebaseapp.com",
      projectId: "ventas-ebd49",
      storageBucket: "ventas-ebd49.firebasestorage.app",
      messagingSenderId: "907042495792",
      appId: "1:907042495792:web:6827da0b73333496f6bcf5"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const parseDate = (input) => {
      if (!input) return new Date();
      if (input.toDate) return input.toDate();
      return new Date(input);
    };

    const money = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(val);
    const formatDate = (input) => new Intl.DateTimeFormat('es-MX', { day: '2-digit', month: 'short', year: 'numeric' }).format(parseDate(input));

    // Función Inteligente para sacar el nombre del Agente
    const getAgentName = (sale) => {
       if (sale.agentEmail) return sale.agentEmail.split('@')[0]; // Toma lo que está antes del @
       if (sale.userId) return 'Agente_' + sale.userId.substring(0, 4); // Para registros viejos
       return 'Sin Asignar';
    };

    const AdminDashboard = ({ user }) => {
      const [allSales, setAllSales] = useState([]);
      const [loading, setLoading] = useState(true);
      const [isAdmin, setIsAdmin] = useState(true); 
      
      // Filtros de BI
      const [selectedAgent, setSelectedAgent] = useState('Todos');

      useEffect(() => {
        const unsub = db.collection('sales')
          .orderBy('fecha', 'desc')
          .onSnapshot(
            snap => {
               const docs = snap.docs.map(d => ({id: d.id, ...d.data()}));
               setAllSales(docs);
               setLoading(false);
            },
            error => {
               console.error("Error de permisos:", error);
               setIsAdmin(false);
               setLoading(false);
            }
          );
        return () => unsub();
      }, []);

      // 1. Obtener lista única de agentes para el filtro
      const agentList = useMemo(() => {
        const names = allSales.map(getAgentName);
        return ['Todos', ...new Set(names)].sort();
      }, [allSales]);

      // 2. Aplicar filtro a los datos
      const filteredSales = useMemo(() => {
        if (selectedAgent === 'Todos') return allSales;
        return allSales.filter(s => getAgentName(s) === selectedAgent);
      }, [allSales, selectedAgent]);

      // 3. KPIs basados en los datos filtrados
      const totalDispersed = filteredSales.filter(s => s.estatus === 'Dispersado').reduce((acc, s) => acc + (Number(s.monto_dispersado) || 0), 0);
      const totalPipeline = filteredSales.filter(s => !['Dispersado','Rechazado','Cancelado'].includes(s.estatus)).reduce((acc, s) => acc + (Number(s.monto_preaprobado) || 0), 0);
      const totalActiveLeads = filteredSales.filter(s => !['Dispersado','Rechazado','Cancelado'].includes(s.estatus)).length;

      // 4. Data para Gráfico de Estatus (Pipeline)
      const chartStatusData = useMemo(() => {
         const counts = {};
         filteredSales.forEach(s => {
            counts[s.estatus] = (counts[s.estatus] || 0) + 1;
         });
         return Object.keys(counts).map(key => ({ name: key, Leads: counts[key] })).sort((a,b) => b.Leads - a.Leads);
      }, [filteredSales]);

      // 5. Data para Gráfico de Pastel (Aportación por Agente) - Solo se ve si está en "Todos"
      const chartPieData = useMemo(() => {
         const totals = {};
         allSales.filter(s => s.estatus === 'Dispersado').forEach(s => {
            const name = getAgentName(s);
            totals[name] = (totals[name] || 0) + (Number(s.monto_dispersado) || 0);
         });
         return Object.keys(totals).map(key => ({ name: key, value: totals[key] }));
      }, [allSales]);

      const COLORS = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#64748b'];

      // Función para exportar CSV
      const exportToCSV = () => {
         const headers = ["Fecha", "Folio", "Cliente", "Telefono", "Agente", "Estatus", "Preaprobado", "Dispersado", "Motivo Perdida"];
         const rows = filteredSales.map(s => [
            formatDate(s.fecha).replace(',', ''),
            s.folio || 'N/A', 
            `"${s.nombre_cliente}"`, 
            s.telefono || '', 
            getAgentName(s),
            s.estatus, 
            s.monto_preaprobado || 0, 
            s.monto_dispersado || 0,
            s.motivo_perdida || ''
         ]);
         const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
         const encodedUri = encodeURI(csvContent);
         const link = document.createElement("a");
         link.setAttribute("href", encodedUri);
         link.setAttribute("download", `Data_Ventas_${selectedAgent}_${new Date().getTime()}.csv`);
         document.body.appendChild(link); link.click(); document.body.removeChild(link);
      };

      if (!isAdmin) {
         return (
            <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-6 text-center">
               <i className="fas fa-lock text-6xl text-red-500 mb-4"></i>
               <h1 className="text-3xl font-bold mb-2">Acceso Denegado</h1>
               <p className="text-slate-400 max-w-md">No tienes los privilegios de Supervisor.</p>
               <button onClick={() => window.location.replace("index.html")} className="mt-6 bg-blue-600 px-6 py-2 rounded font-bold hover:bg-blue-700">Volver al Tablero</button>
            </div>
         );
      }

      if (loading) return <div className="h-screen flex justify-center items-center font-bold text-slate-400 bg-slate-900"><div className="loader mr-4"></div> Generando BI Dashboard...</div>;

      return (
        <div className="flex flex-col h-full bg-slate-50">
          
          {/* Header Superior */}
          <div className="bg-purple-900 text-white p-4 flex flex-wrap justify-between items-center shadow z-10 shrink-0 gap-4">
            <div className="flex items-center gap-3">
              <i className="fas fa-chart-pie text-purple-400 text-3xl"></i>
              <div>
                 <h1 className="font-bold text-xl leading-none">Business Intelligence</h1>
                 <span className="text-xs text-purple-300">Vista de Supervisor</span>
              </div>
            </div>
            
            {/* Barra de Filtros BI */}
            <div className="flex items-center gap-4 bg-purple-800 p-2 rounded-lg border border-purple-700">
               <div className="flex items-center gap-2">
                 <i className="fas fa-filter text-purple-300"></i>
                 <select 
                   value={selectedAgent} 
                   onChange={e => setSelectedAgent(e.target.value)}
                   className="bg-white text-slate-800 text-sm font-bold px-3 py-1.5 rounded outline-none w-48"
                 >
                   {agentList.map(agent => <option key={agent} value={agent}>{agent === 'Todos' ? 'Empresa Global' : agent}</option>)}
                 </select>
               </div>
            </div>

            <div className="flex gap-2">
               <button onClick={exportToCSV} className="bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-sm font-bold flex items-center transition-colors shadow-lg">
                 <i className="fas fa-file-excel mr-2"></i><span className="hidden md:inline">Descargar CSV</span>
               </button>
               <button onClick={() => window.location.replace("index.html")} className="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded text-sm font-bold flex items-center transition-colors shadow-lg">
                 <i className="fas fa-arrow-left md:mr-2"></i><span className="hidden md:inline">Salir</span>
               </button>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-6 flex flex-col gap-6 max-w-7xl mx-auto w-full">
            
            {/* KPIs */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0">
               <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-green-500">
                  <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Volumen Dispersado</p>
                  <p className="text-3xl font-black text-green-600">{money(totalDispersed)}</p>
               </div>
               <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-blue-500">
                  <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Pipeline Vivo</p>
                  <p className="text-3xl font-black text-blue-600">{money(totalPipeline)}</p>
               </div>
               <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500">
                  <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Leads en Gestión</p>
                  <p className="text-3xl font-black text-purple-700">{totalActiveLeads}</p>
               </div>
            </div>

            {/* Zona de Gráficos (BI) */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 shrink-0">
              
              {/* Gráfico 1: Estatus del Pipeline */}
              <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                 <h2 className="font-bold text-slate-700 mb-4 text-sm"><i className="fas fa-chart-bar mr-2 text-blue-500"></i>Concentración de Leads por Estatus</h2>
                 <div className="h-64 w-full">
                   <ResponsiveContainer width="100%" height="100%">
                     <BarChart data={chartStatusData} layout="vertical" margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                       <XAxis type="number" hide />
                       <YAxis dataKey="name" type="category" axisLine={false} tickLine={false} tick={{fontSize: 12, fill: '#64748b', fontWeight: 'bold'}} />
                       <Tooltip cursor={{fill: '#f1f5f9'}} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                       <Bar dataKey="Leads" fill="#3b82f6" radius={[0, 4, 4, 0]} barSize={20}>
                          {chartStatusData.map((entry, index) => (
                             <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                          ))}
                       </Bar>
                     </BarChart>
                   </ResponsiveContainer>
                 </div>
              </div>

              {/* Gráfico 2: Pastel de Agentes (Solo visible si el filtro es "Todos") */}
              <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative">
                 <h2 className="font-bold text-slate-700 mb-4 text-sm"><i className="fas fa-pie-chart mr-2 text-green-500"></i>Aportación de Dispersión por Agente</h2>
                 {selectedAgent !== 'Todos' ? (
                    <div className="absolute inset-0 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-xl z-10">
                       <p className="text-slate-500 font-bold text-sm bg-white px-4 py-2 rounded-full shadow border">Selecciona "Empresa Global" para ver este gráfico</p>
                    </div>
                 ) : null}
                 <div className="h-64 w-full">
                   <ResponsiveContainer width="100%" height="100%">
                     <PieChart>
                       <Pie data={chartPieData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                         {chartPieData.map((entry, index) => ( <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} /> ))}
                       </Pie>
                       <Tooltip formatter={(value) => money(value)} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                       <Legend verticalAlign="bottom" height={36} iconType="circle" wrapperStyle={{fontSize: '12px', fontWeight: 'bold', color: '#475569'}} />
                     </PieChart>
                   </ResponsiveContainer>
                 </div>
              </div>

            </div>

            {/* Data Master Table */}
            <div className="bg-white rounded-xl border border-slate-200 shadow-sm flex-1 flex flex-col min-h-[400px]">
               <div className="p-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                  <h2 className="font-bold text-slate-700"><i className="fas fa-table mr-2 text-slate-500"></i>Tabla de Datos Filtrada</h2>
                  <span className="text-xs font-bold bg-purple-100 text-purple-700 px-3 py-1 rounded-full">{filteredSales.length} Registros</span>
               </div>
               <div className="overflow-auto flex-1">
                 <table className="w-full text-left border-collapse min-w-max">
                   <thead className="bg-white sticky top-0 z-10 shadow-sm">
                     <tr>
                       <th className="py-3 px-4 text-xs font-bold text-slate-500 uppercase border-b">Fecha / Folio</th>
                       <th className="py-3 px-4 text-xs font-bold text-slate-500 uppercase border-b">Cliente</th>
                       <th className="py-3 px-4 text-xs font-bold text-slate-500 uppercase border-b">Agente</th>
                       <th className="py-3 px-4 text-xs font-bold text-slate-500 uppercase border-b">Estatus</th>
                       <th className="py-3 px-4 text-xs font-bold text-slate-500 uppercase text-right border-b">Preaprobado</th>
                     </tr>
                   </thead>
                   <tbody className="divide-y divide-slate-100">
                     {filteredSales.map(sale => (
                       <tr key={sale.id} className="hover:bg-slate-50 transition-colors">
                         <td className="py-3 px-4">
                           <div className="font-mono text-xs font-bold text-slate-700">{sale.folio || 'Sin Folio'}</div>
                           <div className="text-[10px] text-slate-400">{formatDate(sale.fecha)}</div>
                         </td>
                         <td className="py-3 px-4">
                           <div className="font-bold text-sm text-slate-800">{sale.nombre_cliente}</div>
                           {sale.telefono && <div className="text-[10px] text-slate-500 mt-1"><i className="fas fa-phone mr-1"></i>{sale.telefono}</div>}
                         </td>
                         <td className="py-3 px-4">
                           <span className="text-xs font-bold text-purple-700 bg-purple-50 px-2 py-1 rounded-md border border-purple-100">
                             {getAgentName(sale)}
                           </span>
                         </td>
                         <td className="py-3 px-4">
                           <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${sale.estatus === 'Dispersado' ? 'bg-green-100 text-green-700' : sale.estatus === 'Rechazado' || sale.estatus === 'Cancelado' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                             {sale.estatus}
                           </span>
                           {sale.motivo_perdida && <div className="text-[10px] text-red-500 mt-1 font-medium truncate max-w-[120px]" title={sale.motivo_perdida}>{sale.motivo_perdida}</div>}
                         </td>
                         <td className="py-3 px-4 text-right font-bold text-sm text-slate-600">
                           {money(sale.monto_preaprobado)}
                           {sale.estatus === 'Dispersado' && <div className="text-[10px] text-green-600 mt-1">Disp: {money(sale.monto_dispersado)}</div>}
                         </td>
                       </tr>
                     ))}
                     {filteredSales.length === 0 && (
                        <tr><td colSpan="5" className="py-8 text-center text-slate-400 font-bold">No hay registros para este filtro.</td></tr>
                     )}
                   </tbody>
                 </table>
               </div>
            </div>

          </div>
        </div>
      );
    };

    const MainWrapper = () => {
      const [user, setUser] = useState(null);
      const [loadingAuth, setLoadingAuth] = useState(true);

      useEffect(() => {
        return auth.onAuthStateChanged((u) => {
          if (!u) window.location.replace("index.html");
          else { setUser(u); setLoadingAuth(false); }
        });
      }, []);

      if (loadingAuth) return <div className="h-screen bg-slate-900 flex justify-center items-center text-white font-bold"><div className="loader mr-4"></div>Verificando seguridad...</div>;
      
      return <AdminDashboard user={user} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MainWrapper />);
  </script>
</body>
</html>
 
