<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Pro - Tracking & Metas</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    .pipeline-scroll { scroll-snap-type: x mandatory; }
    .pipeline-col { scroll-snap-align: start; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen flex flex-col overflow-hidden">
  
  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // --- 1. CONFIGURACIÓN FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAAETou6DhYIJJ8cxI13BU1p_l3yGPMilA",
      authDomain: "ventas-ebd49.firebaseapp.com",
      projectId: "ventas-ebd49",
      storageBucket: "ventas-ebd49.firebasestorage.app",
      messagingSenderId: "907042495792",
      appId: "1:907042495792:web:6827da0b73333496f6bcf5"
    };
    
    // Inicializar solo si no existe
    if (!firebase.apps.length) {
       firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --- 2. UTILIDADES ---
    const formatMoney = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(amount);
    
    const formatDate = (timestamp) => {
      if (!timestamp) return '';
      // Manejar timestamp de Firebase o fecha JS
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return new Intl.DateTimeFormat('es-MX', { day: '2-digit', month: 'short', hour: '2-digit', minute:'2-digit' }).format(date);
    };

    // Cálculo de días hábiles (Lunes a Viernes)
    const getBusinessDays = () => {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const lastDay = new Date(year, month + 1, 0).getDate();
      let totalBusinessDays = 0;
      let passedBusinessDays = 0;
      const todayDate = now.getDate();

      for (let day = 1; day <= lastDay; day++) {
        const current = new Date(year, month, day);
        const dayOfWeek = current.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 0=Dom, 6=Sab
          totalBusinessDays++;
          if (day <= todayDate) passedBusinessDays++;
        }
      }
      return { totalBusinessDays, passedBusinessDays };
    };

    // --- 3. COMPONENTES ---

    // === METRICS DASHBOARD ===
    const Dashboard = ({ sales, metaData, updateMeta }) => {
      const { totalBusinessDays, passedBusinessDays } = getBusinessDays();
      
      // CORRECCIÓN: Validación segura en lugar de Optional Chaining para evitar error de sintaxis
      const metaMensual = (metaData && metaData.monto) ? metaData.monto : 0;
      
      const dispersado = sales.filter(s => s.estatus === 'Dispersado')
                              .reduce((acc, curr) => acc + Number(curr.monto_dispersado || 0), 0);

      // Cálculos Matemáticos
      const avance = metaMensual > 0 ? (dispersado / metaMensual) * 100 : 0;
      const metaDiaria = totalBusinessDays > 0 ? metaMensual / totalBusinessDays : 0;
      const deberiaLlevar = metaDiaria * passedBusinessDays;
      const deficit = dispersado - deberiaLlevar;
      const isDeficit = deficit < 0;

      const [isEditingMeta, setIsEditingMeta] = useState(false);
      const [tempMeta, setTempMeta] = useState(metaMensual);

      // Efecto para actualizar tempMeta cuando llega la data real
      useEffect(() => {
        setTempMeta(metaMensual);
      }, [metaMensual]);

      const saveMeta = () => {
        updateMeta(tempMeta);
        setIsEditingMeta(false);
      };

      return (
        <div className="bg-white border-b border-gray-200 p-2 md:p-4 shadow-sm z-20 overflow-x-auto">
          <div className="flex gap-4 min-w-max">
            
            {/* KPI 1: Resumen General */}
            <div className="flex flex-col justify-center min-w-[150px]">
              <span className="text-xs text-gray-500 uppercase font-bold">Total Dispersado</span>
              <span className="text-2xl font-black text-gray-800">{formatMoney(dispersado)}</span>
              <span className="text-xs text-gray-400">{sales.length} leads totales</span>
            </div>

            {/* KPI 2: Semáforo de Meta */}
            <div className="bg-gray-50 rounded p-2 border border-gray-200 min-w-[200px] flex flex-col justify-center relative">
              <div className="flex justify-between items-center mb-1">
                <span className="text-[10px] font-bold uppercase text-gray-500">Meta Mensual</span>
                {isEditingMeta ? (
                  <div className="flex items-center gap-1">
                    <input type="number" value={tempMeta} onChange={e => setTempMeta(e.target.value)} className="w-20 text-xs border rounded p-1" autoFocus />
                    <button onClick={saveMeta} className="text-green-600"><i className="fas fa-check"></i></button>
                  </div>
                ) : (
                  <div className="flex items-center gap-2 cursor-pointer hover:bg-gray-100 rounded px-1" onClick={() => setIsEditingMeta(true)}>
                    <span className="text-sm font-bold">{formatMoney(metaMensual)}</span>
                    <i className="fas fa-pencil-alt text-[10px] text-gray-400"></i>
                  </div>
                )}
              </div>
              <div className="w-full bg-gray-200 rounded-full h-1.5 mb-1">
                <div className={`h-1.5 rounded-full ${avance >= 100 ? 'bg-green-500' : 'bg-blue-600'}`} style={{ width: `${Math.min(avance, 100)}%` }}></div>
              </div>
              <span className="text-[10px] text-right text-blue-600 font-bold">{avance.toFixed(1)}% Alcanzado</span>
            </div>

            {/* KPI 3: Análisis Diario y Déficit */}
            <div className={`rounded p-2 border min-w-[220px] flex flex-col justify-center ${isDeficit ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100'}`}>
              <div className="flex justify-between">
                <span className="text-[10px] font-bold uppercase text-gray-500">Días Hábiles: {passedBusinessDays}/{totalBusinessDays}</span>
                <span className="text-[10px] font-bold uppercase text-gray-500">Meta Diaria: {formatMoney(metaDiaria)}</span>
              </div>
              <div className="mt-1">
                 <span className="text-[10px] block text-gray-500">Estado Actual (Vs. Tiempo):</span>
                 <span className={`text-lg font-black ${isDeficit ? 'text-red-600' : 'text-green-600'}`}>
                   {isDeficit ? '-' : '+'}{formatMoney(Math.abs(deficit))}
                 </span>
              </div>
            </div>

          </div>
        </div>
      );
    };

    // === SALE CARD ===
    const SaleCard = ({ sale, updateSale }) => {
      const [expanded, setExpanded] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      
      const [estatus, setEstatus] = useState(sale.estatus);
      const [comment, setComment] = useState('');

      const handleStatusChange = (newStatus) => {
        setEstatus(newStatus);
        const historyItem = {
          date: new Date(),
          action: `Cambio de estatus: ${sale.estatus} -> ${newStatus}`,
          user: 'Usuario'
        };
        
        updateSale(sale.id, { 
          estatus: newStatus,
          history: firebase.firestore.FieldValue.arrayUnion(historyItem)
        });
      };

      const addComment = (e) => {
        e.preventDefault();
        if(!comment.trim()) return;
        
        const historyItem = {
          date: new Date(),
          action: `Nota: ${comment}`,
          type: 'comment'
        };

        updateSale(sale.id, {
          history: firebase.firestore.FieldValue.arrayUnion(historyItem)
        });
        setComment('');
      };

      return (
        <div className="bg-white p-3 rounded-lg shadow-sm border-l-4 mb-3 hover:shadow-md transition-all relative group"
             style={{ borderLeftColor: sale.estatus === 'Dispersado' ? '#10B981' : '#3B82F6' }}>
          
          {/* Header Card */}
          <div className="flex justify-between items-start mb-2" onClick={() => setExpanded(!expanded)}>
             <div>
                <span className="text-[10px] text-gray-400 font-mono bg-gray-50 px-1 rounded">{sale.folio}</span>
                <h3 className="font-bold text-gray-800 leading-tight cursor-pointer">{sale.nombre_cliente}</h3>
                <p className="text-[10px] text-gray-400 mt-0.5"><i className="far fa-clock mr-1"></i>{formatDate(sale.fecha)}</p>
             </div>
             <div className="text-right">
                <span className="block font-bold text-gray-700">{formatMoney(sale.monto_preaprobado)}</span>
             </div>
          </div>

          {/* Actions Bar (Contact) */}
          <div className="flex gap-2 mb-3 border-b border-gray-100 pb-2">
            {sale.telefono && (
              <a href={`tel:${sale.telefono}`} className="text-gray-400 hover:text-green-600 bg-gray-50 w-6 h-6 rounded-full flex items-center justify-center transition-colors">
                <i className="fas fa-phone text-xs"></i>
              </a>
            )}
             {sale.email && (
              <a href={`mailto:${sale.email}`} className="text-gray-400 hover:text-blue-600 bg-gray-50 w-6 h-6 rounded-full flex items-center justify-center transition-colors">
                <i className="fas fa-envelope text-xs"></i>
              </a>
            )}
            {sale.url && (
              <a href={sale.url} target="_blank" className="text-gray-400 hover:text-purple-600 bg-gray-50 w-6 h-6 rounded-full flex items-center justify-center transition-colors">
                <i className="fas fa-external-link-alt text-xs"></i>
              </a>
            )}
          </div>

          {/* Quick Status Change */}
          <select 
            value={estatus} 
            onChange={(e) => handleStatusChange(e.target.value)}
            className="w-full text-xs border border-gray-300 rounded p-1.5 bg-gray-50 mb-2 focus:ring-1 focus:ring-blue-500 outline-none"
          >
            {["Con oferta", "Acepta oferta", "Dispersado", "Rechazado", "Cancelado"].map(opt => (
              <option key={opt} value={opt}>{opt}</option>
            ))}
          </select>
          
          {/* Footer Expandible: Historial y Notas */}
          <button onClick={() => setShowHistory(!showHistory)} className="text-[10px] text-gray-400 hover:text-blue-600 underline w-full text-left">
             {showHistory ? 'Ocultar bitácora' : `Ver bitácora (${sale.history ? sale.history.length : 0})`}
          </button>

          {showHistory && (
            <div className="mt-2 bg-gray-50 p-2 rounded text-xs border border-gray-100">
               <ul className="max-h-32 overflow-y-auto space-y-2 mb-2">
                 {sale.history && sale.history.slice().reverse().map((h, i) => (
                   <li key={i} className="flex flex-col border-b border-gray-200 pb-1 last:border-0">
                      <span className="font-bold text-[9px] text-gray-400">{formatDate(h.date)}</span>
                      <span className="text-gray-700">{h.action}</span>
                   </li>
                 ))}
               </ul>
               <form onSubmit={addComment} className="flex gap-1">
                 <input 
                   type="text" 
                   value={comment}
                   onChange={e => setComment(e.target.value)}
                   placeholder="Agregar nota..."
                   className="flex-1 border rounded px-1 py-0.5 text-xs"
                 />
                 <button type="submit" className="bg-blue-600 text-white px-2 rounded"><i className="fas fa-paper-plane"></i></button>
               </form>
            </div>
          )}
        </div>
      );
    };

    // === FORMULARIO NUEVO LEAD ===
    const SaleForm = ({ onSubmit, onCancel }) => {
      const [formData, setFormData] = useState({
        nombre_cliente: '',
        monto_preaprobado: '',
        telefono: '',
        email: '',
        url: '',
        estatus: 'Con oferta'
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        const initialHistory = [{
          date: new Date(),
          action: 'Lead creado',
          user: 'Sistema'
        }];

        onSubmit({
          ...formData,
          monto_preaprobado: Number(formData.monto_preaprobado),
          monto_dispersado: 0,
          history: initialHistory
        });
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
            <div className="bg-gray-900 text-white p-3 flex justify-between items-center">
              <h2 className="font-bold">Nuevo Lead</h2>
              <button onClick={onCancel} className="text-gray-400 hover:text-white"><i className="fas fa-times"></i></button>
            </div>
            <form onSubmit={handleSubmit} className="p-4 flex flex-col gap-3">
              <div>
                <label className="text-xs font-bold text-gray-500">Datos del Cliente</label>
                <input required type="text" placeholder="Nombre completo" className="w-full border p-2 rounded text-sm mt-1"
                       value={formData.nombre_cliente} onChange={e => setFormData({...formData, nombre_cliente: e.target.value})} />
              </div>
              
              <div className="grid grid-cols-2 gap-2">
                 <input type="number" placeholder="Monto ($)" className="w-full border p-2 rounded text-sm"
                        value={formData.monto_preaprobado} onChange={e => setFormData({...formData, monto_preaprobado: e.target.value})} />
                 <input type="tel" placeholder="Teléfono" className="w-full border p-2 rounded text-sm"
                        value={formData.telefono} onChange={e => setFormData({...formData, telefono: e.target.value})} />
              </div>

              <div className="grid grid-cols-2 gap-2">
                 <input type="email" placeholder="Email" className="w-full border p-2 rounded text-sm"
                        value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                 <input type="url" placeholder="URL (LinkedIn/CRM)" className="w-full border p-2 rounded text-sm"
                        value={formData.url} onChange={e => setFormData({...formData, url: e.target.value})} />
              </div>

              <div className="pt-2 flex gap-2">
                <button type="submit" className="flex-1 bg-green-600 text-white p-2 rounded font-bold text-sm hover:bg-green-500">Guardar</button>
                <button type="button" onClick={onCancel} className="flex-1 bg-gray-200 text-gray-700 p-2 rounded font-bold text-sm">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // === APP PRINCIPAL ===
    const App = () => {
      const [sales, setSales] = useState([]);
      const [metaData, setMetaData] = useState({ monto: 100000 });
      const [showForm, setShowForm] = useState(false);
      const [loading, setLoading] = useState(true);

      // Listener Ventas
      useEffect(() => {
        const unsubscribe = db.collection('sales')
          .orderBy('fecha', 'desc')
          .onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setSales(data);
            setLoading(false);
          }, (error) => {
             console.error("Error cargando ventas:", error);
             setLoading(false);
          });
        return () => unsubscribe();
      }, []);

      // Listener Configuración (Meta Persistente)
      useEffect(() => {
        const docRef = db.collection('config').doc('general');
        const unsubscribe = docRef.onSnapshot(doc => {
          if (doc.exists) setMetaData(doc.data());
          else {
             // Crear si no existe
             docRef.set({ monto: 100000 });
          }
        }, (error) => {
            // Si falla por permisos (primera vez), usar default sin crashear
            console.log("Esperando inicialización de config...", error);
        });
        return () => unsubscribe();
      }, []);

      const addSale = async (data) => {
        try {
          const folio = `FOL-${Math.floor(Math.random() * 10000)}`;
          await db.collection('sales').add({
            ...data,
            folio,
            fecha: firebase.firestore.Timestamp.now(), // Fecha servidor
            actualizado: firebase.firestore.Timestamp.now()
          });
          setShowForm(false);
        } catch (err) {
          console.error(err);
          alert("Error al guardar. Verifica tu conexión.");
        }
      };

      const updateSale = async (id, data) => {
        try {
          await db.collection('sales').doc(id).update({
            ...data,
            actualizado: firebase.firestore.Timestamp.now()
          });
        } catch(err) {
           console.error("Error actualizando", err);
        }
      };

      const updateMeta = async (newAmount) => {
        try {
           await db.collection('config').doc('general').set({ monto: Number(newAmount) }, { merge: true });
        } catch(err) {
           console.error("Error guardando meta", err);
           alert("No se pudo guardar la meta. Verifica permisos de Firebase.");
        }
      };

      if (loading) return <div className="h-full flex items-center justify-center bg-gray-100 text-gray-500">Cargando CRM...</div>;

      const estatusCols = ["Con oferta", "Acepta oferta", "Dispersado", "Rechazado", "Cancelado"];

      return (
        <div className="flex flex-col h-full bg-gray-100">
          
          {/* HEADER */}
          <header className="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md">
            <h1 className="font-bold text-lg"><i className="fas fa-chart-line text-green-400 mr-2"></i>SalesBoard</h1>
            <button onClick={() => setShowForm(true)} className="bg-green-600 hover:bg-green-500 px-3 py-1.5 rounded text-sm font-bold shadow transition-transform active:scale-95">
              <i className="fas fa-plus mr-1"></i> Nuevo
            </button>
          </header>

          {/* DASHBOARD */}
          <Dashboard sales={sales} metaData={metaData} updateMeta={updateMeta} />

          {/* PIPELINE KANBAN */}
          <div className="flex-1 overflow-x-auto p-4 flex gap-4 pipeline-scroll items-start">
            {estatusCols.map(est => {
               const items = sales.filter(s => s.estatus === est);
               return (
                 <div key={est} className="min-w-[280px] w-[280px] flex flex-col h-full bg-gray-200/50 rounded-xl border border-gray-300/60 pipeline-col">
                    <div className="p-3 font-bold text-gray-700 text-sm flex justify-between items-center bg-gray-100/50 rounded-t-xl border-b border-gray-200">
                      {est}
                      <span className="bg-white px-2 py-0.5 rounded-full text-xs shadow-sm text-gray-500">{items.length}</span>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2">
                       {items.map(sale => <SaleCard key={sale.id} sale={sale} updateSale={updateSale} />)}
                    </div>
                 </div>
               )
            })}
          </div>

          {/* MODAL */}
          {showForm && <SaleForm onSubmit={addSale} onCancel={() => setShowForm(false)} />}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
 
