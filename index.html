<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Ventas - Serverless</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    .pipeline-scroll { scroll-snap-type: x mandatory; }
    .pipeline-col { scroll-snap-align: start; }
    /* Custom scrollbar para mejor UX */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; rounded: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans antialiased h-screen flex flex-col overflow-hidden">
  
  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ==========================================
    // 1. CONFIGURACIÃ“N FIREBASE
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyAAETou6DhYIJJ8cxI13BU1p_l3yGPMilA",
      authDomain: "ventas-ebd49.firebaseapp.com",
      projectId: "ventas-ebd49",
      storageBucket: "ventas-ebd49.firebasestorage.app",
      messagingSenderId: "907042495792",
      appId: "1:907042495792:web:6827da0b73333496f6bcf5"
    };
    
    // Inicializar solo si no existe
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // ==========================================
    // 2. CONSTANTES
    // ==========================================
    const ESTATUS_LIST = ["Con oferta", "Acepta oferta", "Dispersado", "Rechazado", "Cancelado"];

    // ==========================================
    // 3. COMPONENTES
    // ==========================================

    // --- Componente: Dashboard ---
    const Dashboard = ({ sales, metaMensual, setMetaMensual }) => {
      const leadsTotales = sales.length;
      const dispersadas = sales.filter(s => s.estatus === 'Dispersado');
      const montoDispersado = dispersadas.reduce((acc, curr) => acc + Number(curr.monto_dispersado || 0), 0);
      const avance = metaMensual > 0 ? ((montoDispersado / metaMensual) * 100).toFixed(1) : 0;

      return (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 flex-shrink-0">
          <div className="bg-white p-3 md:p-4 rounded-lg shadow-sm border-l-4 border-gray-500">
            <p className="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-wider">Total Leads</p>
            <p className="text-xl md:text-2xl font-black text-gray-800">{leadsTotales}</p>
          </div>
          <div className="bg-white p-3 md:p-4 rounded-lg shadow-sm border-l-4 border-green-500">
            <p className="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-wider">Dispersadas</p>
            <p className="text-xl md:text-2xl font-black text-gray-800">{dispersadas.length}</p>
          </div>
          <div className="bg-white p-3 md:p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
            <p className="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-wider">Monto Total</p>
            <p className="text-xl md:text-2xl font-black text-gray-800">${montoDispersado.toLocaleString()}</p>
          </div>
          <div className="bg-white p-3 md:p-4 rounded-lg shadow-sm border-l-4 border-purple-500 flex flex-col justify-center">
            <div className="flex justify-between items-center mb-2">
              <p className="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-wider">Meta ({avance}%)</p>
              <input 
                type="number" 
                value={metaMensual} 
                onChange={(e) => setMetaMensual(Number(e.target.value))}
                className="w-20 text-xs border rounded px-1 text-right font-mono bg-gray-50 focus:outline-none focus:ring-1 focus:ring-purple-500"
              />
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div className="bg-purple-600 h-2 rounded-full transition-all duration-500" style={{ width: `${Math.min(avance, 100)}%` }}></div>
            </div>
          </div>
        </div>
      );
    };

    // --- Componente: Formulario de Venta ---
    const SaleForm = ({ onSubmit, onCancel }) => {
      const [formData, setFormData] = useState({
        nombre_cliente: '',
        monto_preaprobado: '',
        estatus: 'Con oferta',
        subestatus: '',
        comentario: '',
        monto_dispersado: 0
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit({
          ...formData,
          monto_preaprobado: Number(formData.monto_preaprobado),
          monto_dispersado: formData.estatus === 'Dispersado' ? Number(formData.monto_preaprobado) : 0
        });
      };

      return (
        <form onSubmit={handleSubmit} className="bg-white p-4 rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4 flex-shrink-0 border border-gray-200">
          <input required type="text" placeholder="Nombre del Cliente" className="border border-gray-300 p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                 value={formData.nombre_cliente} onChange={e => setFormData({...formData, nombre_cliente: e.target.value})} />
          
          <input required type="number" placeholder="Monto Preaprobado" className="border border-gray-300 p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                 value={formData.monto_preaprobado} onChange={e => setFormData({...formData, monto_preaprobado: e.target.value})} />
          
          <div className="flex gap-2 md:col-span-2">
            <button type="submit" className="flex-1 bg-gray-900 text-white font-bold p-2 rounded text-sm hover:bg-gray-800 transition-colors">
              Guardar Lead
            </button>
            <button type="button" onClick={onCancel} className="bg-gray-200 text-gray-700 font-bold p-2 rounded text-sm hover:bg-gray-300 transition-colors">
              Cancelar
            </button>
          </div>
        </form>
      );
    };

    // --- Componente: Tarjeta de Venta ---
    const SaleCard = ({ sale, updateSale }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [formData, setFormData] = useState({
        estatus: sale.estatus,
        subestatus: sale.subestatus || '',
        comentario: sale.comentario || '',
        monto_dispersado: sale.monto_dispersado || sale.monto_preaprobado
      });

      const handleSave = (e) => {
        e.stopPropagation();
        updateSale(sale.id, {
          ...formData,
          monto_dispersado: Number(formData.monto_dispersado)
        });
        setIsEditing(false);
      };

      if (isEditing) {
        return (
          <div className="bg-white p-3 rounded shadow-md border-2 border-blue-400 flex flex-col gap-2 text-sm z-10 relative">
            <select 
              value={formData.estatus}
              onChange={(e) => setFormData({...formData, estatus: e.target.value})}
              className="border border-gray-300 p-1.5 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500"
            >
              {ESTATUS_LIST.map(est => <option key={est} value={est}>{est}</option>)}
            </select>
            
            {formData.estatus === 'Dispersado' && (
              <input 
                type="number" 
                placeholder="Monto final dispersado"
                value={formData.monto_dispersado}
                onChange={(e) => setFormData({...formData, monto_dispersado: e.target.value})}
                className="border border-gray-300 p-1.5 rounded bg-green-50 focus:outline-none focus:ring-1 focus:ring-green-500"
              />
            )}
            
            <input 
              type="text" 
              placeholder="Subestatus (ej. Falta firma)"
              value={formData.subestatus}
              onChange={(e) => setFormData({...formData, subestatus: e.target.value})}
              className="border border-gray-300 p-1.5 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
            
            <textarea 
              placeholder="Notas/Comentarios..."
              value={formData.comentario}
              onChange={(e) => setFormData({...formData, comentario: e.target.value})}
              className="border border-gray-300 p-1.5 rounded resize-none h-16 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
            
            <div className="flex gap-2 mt-1">
              <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 text-white font-medium px-2 py-1.5 rounded w-full text-xs transition-colors">Guardar</button>
              <button onClick={(e) => { e.stopPropagation(); setIsEditing(false); }} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-2 py-1.5 rounded w-full text-xs transition-colors">Cancelar</button>
            </div>
          </div>
        );
      }

      const colorMap = {
        'Con oferta': '#3B82F6',
        'Acepta oferta': '#8B5CF6',
        'Dispersado': '#10B981',
        'Rechazado': '#EF4444',
        'Cancelado': '#6B7280'
      };

      return (
        <div className="bg-white p-3 rounded shadow-sm cursor-pointer border-l-4 hover:shadow-md transition-all group" 
             style={{ borderLeftColor: colorMap[sale.estatus] }}
             onClick={() => setIsEditing(true)}>
          <div className="flex justify-between items-center mb-1.5">
            <span className="text-[10px] font-mono text-gray-400 bg-gray-50 px-1 rounded">{sale.folio}</span>
          </div>
          
          <h3 className="font-bold text-gray-800 text-sm leading-tight">{sale.nombre_cliente}</h3>
          
          <div className="mt-2 flex justify-between items-end">
             <div className="flex flex-col">
                <span className="text-[10px] text-gray-400">Preaprobado</span>
                <span className="text-xs font-medium text-gray-600">${Number(sale.monto_preaprobado).toLocaleString()}</span>
             </div>
             {sale.estatus === 'Dispersado' && (
               <div className="flex flex-col items-end">
                  <span className="text-[10px] text-green-500 font-bold">Dispersado</span>
                  <span className="text-sm font-black text-green-600">${Number(sale.monto_dispersado).toLocaleString()}</span>
               </div>
             )}
          </div>
          
          {(sale.subestatus || sale.comentario) && (
            <div className="mt-2.5 pt-2 border-t border-gray-100">
              {sale.subestatus && <span className="inline-block bg-blue-50 text-blue-700 text-[10px] px-2 py-0.5 rounded-full mb-1 font-medium border border-blue-100">{sale.subestatus}</span>}
              {sale.comentario && <p className="text-[11px] text-gray-500 line-clamp-2 leading-tight bg-gray-50 p-1.5 rounded">{sale.comentario}</p>}
            </div>
          )}
        </div>
      );
    };

    // --- Componente: Pipeline ---
    const Pipeline = ({ sales, updateSale }) => {
      return (
        <div className="flex-1 flex overflow-x-auto gap-4 pb-4 pt-2 pipeline-scroll items-start min-h-0">
          {ESTATUS_LIST.map(estatus => {
            const columnSales = sales.filter(s => s.estatus === estatus);
            return (
              <div key={estatus} className="min-w-[280px] w-[280px] bg-gray-200/70 rounded-lg flex flex-col h-full pipeline-col flex-shrink-0 border border-gray-300/50">
                <div className="p-3 font-bold flex justify-between items-center bg-gray-200/80 rounded-t-lg border-b border-gray-300">
                  <span className="text-sm text-gray-700">{estatus}</span>
                  <span className="bg-white text-gray-600 text-xs px-2 py-0.5 rounded-full shadow-sm font-mono">{columnSales.length}</span>
                </div>
                <div className="p-2 flex-1 overflow-y-auto flex flex-col gap-2">
                  {columnSales.map(sale => (
                    <SaleCard key={sale.id} sale={sale} updateSale={updateSale} />
                  ))}
                  {columnSales.length === 0 && (
                    <div className="text-center p-4 text-xs text-gray-400 border-2 border-dashed border-gray-300 rounded m-2">
                      Sin registros
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    // --- Componente Principal: App ---
    const App = () => {
      const [sales, setSales] = useState([]);
      const [loading, setLoading] = useState(true);
      const [metaMensual, setMetaMensual] = useState(100000);
      const [showForm, setShowForm] = useState(false);

      // Listener de Firebase
      useEffect(() => {
        const unsubscribe = db.collection('sales')
          .orderBy('fecha', 'desc')
          .onSnapshot((snapshot) => {
            const salesData = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            setSales(salesData);
            setLoading(false);
          }, (error) => {
            console.error("Error al obtener ventas: ", error);
            setLoading(false);
          });

        return () => unsubscribe();
      }, []);

      const addSale = async (data) => {
        const folio = `FOL-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
        try {
          await db.collection('sales').add({
            ...data,
            folio,
            fecha: firebase.firestore.FieldValue.serverTimestamp(),
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp(),
          });
          setShowForm(false);
        } catch (error) {
          alert("Error al guardar. Revisa las reglas de Firestore.");
          console.error(error);
        }
      };

      const updateSale = async (id, data) => {
        try {
          await db.collection('sales').doc(id).update({
            ...data,
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (error) {
          alert("Error al actualizar.");
          console.error(error);
        }
      };

      if (loading) return (
        <div className="flex-1 flex items-center justify-center bg-gray-100">
          <div className="animate-pulse flex flex-col items-center">
            <div className="h-12 w-12 bg-gray-300 rounded-full mb-4"></div>
            <p className="text-gray-500 font-medium">Conectando con Firebase...</p>
          </div>
        </div>
      );

      return (
        <div className="flex flex-col h-full">
          <header className="bg-gray-900 text-white p-3 md:p-4 flex justify-between items-center shadow-md z-10 flex-shrink-0">
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-green-500 rounded flex items-center justify-center font-bold text-xs text-gray-900">CRM</div>
              <h1 className="text-lg font-bold tracking-tight">SalesBoard</h1>
            </div>
            <button 
              onClick={() => setShowForm(!showForm)}
              className="bg-green-500 text-gray-900 px-3 md:px-4 py-1.5 md:py-2 rounded font-bold text-sm hover:bg-green-400 transition-colors shadow-sm"
            >
              {showForm ? 'Cerrar' : '+ Nuevo Lead'}
            </button>
          </header>

          <main className="flex-1 p-3 md:p-5 flex flex-col gap-4 md:gap-5 overflow-hidden">
            <Dashboard sales={sales} metaMensual={metaMensual} setMetaMensual={setMetaMensual} />
            
            {showForm && (
              <SaleForm onSubmit={addSale} onCancel={() => setShowForm(false)} />
            )}

            <Pipeline sales={sales} updateSale={updateSale} />
          </main>
        </div>
      );
    };

    // ==========================================
    // 4. RENDERIZADO DOM
    // ==========================================
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

