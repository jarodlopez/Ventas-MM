<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Ventas - Tablero Multi-Agente</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    .pipeline-scroll { scroll-snap-type: x mandatory; }
    .pipeline-col { scroll-snap-align: start; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    body { font-family: 'Inter', system-ui, sans-serif; }
    .glass-modal { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
    /* Animación de carga */
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-100 text-slate-900 h-screen flex flex-col overflow-hidden">
  
  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyAAETou6DhYIJJ8cxI13BU1p_l3yGPMilA",
      authDomain: "ventas-ebd49.firebaseapp.com",
      projectId: "ventas-ebd49",
      storageBucket: "ventas-ebd49.firebasestorage.app",
      messagingSenderId: "907042495792",
      appId: "1:907042495792:web:6827da0b73333496f6bcf5"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const PIPELINE_STATUSES = ["Con oferta", "Acepta oferta", "Long track", "Dispersado", "Rechazado", "Cancelado"];

    const parseDate = (input) => {
      if (!input) return new Date();
      if (input.toDate) return input.toDate();
      return new Date(input);
    };

    const money = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(val);
    const formatDate = (input) => new Intl.DateTimeFormat('es-MX', { day: '2-digit', month: 'short', hour:'2-digit', minute:'2-digit' }).format(parseDate(input));

    const getQuincena = (date) => date.getDate() <= 15 ? 1 : 2;

    const getBusinessDaysQuincena = (targetDate, quincena) => {
      const year = targetDate.getFullYear();
      const month = targetDate.getMonth();
      const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
      const startDay = quincena === 1 ? 1 : 16;
      const endDay = quincena === 1 ? 15 : lastDayOfMonth;
      let totalBusinessDays = 0, remainingDays = 0;
      const today = new Date(), currentDay = today.getDate(), isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

      for (let d = startDay; d <= endDay; d++) {
        const dateCheck = new Date(year, month, d);
        if (dateCheck.getDay() !== 0 && dateCheck.getDay() !== 6) { 
          totalBusinessDays++;
          if (isCurrentMonth && d >= currentDay) remainingDays++;
          else if (!isCurrentMonth && new Date() < dateCheck) remainingDays++;
        }
      }
      return { totalBusinessDays, remainingDays, startDay, endDay };
    };

    const Login = () => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [isRegistering, setIsRegistering] = useState(false);
      const [error, setError] = useState('');

      const handleGoogleLogin = () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => setError("Error con Google: " + err.message));
      };

      const handleEmailAuth = (e) => {
        e.preventDefault();
        setError('');
        if (isRegistering) {
          auth.createUserWithEmailAndPassword(email, password)
            .catch(err => setError(err.code === 'auth/email-already-in-use' ? 'El correo ya está registrado.' : err.message));
        } else {
          auth.signInWithEmailAndPassword(email, password)
            .catch(err => setError(err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' ? 'Datos incorrectos.' : err.message));
        }
      };

      return (
        <div className="flex-1 flex flex-col items-center justify-center bg-slate-900 text-slate-900 p-4">
          <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm flex flex-col items-center">
            <i className="fas fa-chart-line text-5xl text-blue-600 mb-4"></i>
            <h1 className="text-2xl font-black mb-1">CRM Ventas</h1>
            <p className="text-sm text-slate-500 mb-6">{isRegistering ? 'Crear cuenta' : 'Ingreso Agentes'}</p>

            {error && <div className="w-full bg-red-100 text-red-600 p-2 rounded text-xs font-bold text-center mb-4">{error}</div>}

            <form onSubmit={handleEmailAuth} className="w-full flex flex-col gap-3 mb-6">
              <input type="email" placeholder="Correo" required value={email} onChange={e => setEmail(e.target.value)} className="w-full border p-2 rounded focus:outline-none focus:border-blue-500" />
              <input type="password" placeholder="Contraseña" required value={password} onChange={e => setPassword(e.target.value)} className="w-full border p-2 rounded focus:outline-none focus:border-blue-500" />
              <button type="submit" className="w-full bg-blue-600 text-white font-bold p-2 rounded hover:bg-blue-700 mt-1">{isRegistering ? 'Registrarse' : 'Iniciar Sesión'}</button>
            </form>

            <div className="w-full flex items-center gap-2 mb-6"><div className="h-px bg-slate-200 flex-1"></div><span className="text-xs text-slate-400 font-bold uppercase">O entra con</span><div className="h-px bg-slate-200 flex-1"></div></div>

            <button onClick={handleGoogleLogin} className="w-full bg-slate-50 border border-slate-200 text-slate-700 p-2 rounded font-bold hover:bg-slate-100 flex items-center justify-center gap-2">
              <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" /> Google
            </button>

            <button onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="mt-6 text-sm text-blue-600 hover:underline">{isRegistering ? '¿Ya tienes cuenta? Inicia sesión' : '¿No tienes cuenta? Regístrate'}</button>
          </div>
        </div>
      );
    };

    const PlanningModal = ({ isOpen, onClose, meta, setMeta, businessData, year, month, quincena }) => {
      const [localMeta, setLocalMeta] = useState(meta || 0);

      useEffect(() => {
        setLocalMeta(meta || 0);
      }, [meta, isOpen]);

      const handleSaveMeta = () => {
        if(Number(localMeta) !== meta) {
           setMeta(Number(localMeta));
        }
      };

      if (!isOpen) return null;

      const dailyGoal = businessData.totalBusinessDays > 0 ? localMeta / businessData.totalBusinessDays : 0;
      const projection = [];
      let accum = 0;
      const today = new Date().getDate();
      const isCurrentMonth = new Date().getMonth() === month && new Date().getFullYear() === year;

      for(let d = businessData.startDay; d <= businessData.endDay; d++){
         const date = new Date(year, month, d);
         const isWeekend = date.getDay() === 0 || date.getDay() === 6;
         if(!isWeekend) accum += dailyGoal;
         projection.push({ day: d, isWeekend, expected: accum, isToday: isCurrentMonth && d === today });
      }

      return (
        <div className="fixed inset-0 glass-modal z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg h-[80vh] flex flex-col overflow-hidden">
            <div className="p-4 bg-slate-50 border-b flex justify-between items-center">
              <h2 className="font-bold text-lg text-blue-900">Planificación Q{quincena}</h2>
              <button onClick={onClose}><i className="fas fa-times text-slate-400"></i></button>
            </div>
            
            <div className="p-4 bg-blue-50 border-b flex gap-2 items-center">
               <label className="font-bold text-sm text-blue-900">Meta Quincenal ($):</label>
               <input 
                 type="number" 
                 value={localMeta} 
                 onChange={(e) => setLocalMeta(e.target.value)} 
                 onBlur={handleSaveMeta}
                 onKeyDown={(e) => { if(e.key === 'Enter') { e.target.blur(); } }}
                 className="border-2 border-blue-200 rounded px-2 py-1 font-bold w-36 text-blue-900 focus:outline-none focus:border-blue-500" 
               />
               <span className="text-xs text-blue-400 italic">(Presiona Enter para guardar)</span>
            </div>

            <div className="flex-1 overflow-y-auto p-2">
              <table className="w-full text-sm">
                <thead><tr className="text-left text-xs uppercase text-slate-500"><th className="p-2">Día</th><th className="p-2 text-right">Acumulado Ideal</th></tr></thead>
                <tbody>
                  {projection.map(row => (
                    <tr key={row.day} className={`border-b ${row.isWeekend ? 'bg-slate-50 text-slate-400' : ''} ${row.isToday ? 'bg-blue-100 font-bold border-l-4 border-blue-500' : ''}`}>
                      <td className="p-2 flex items-center gap-2">{row.day} {row.isWeekend && '(Fin)'} {row.isToday && <span className="text-[10px] bg-blue-500 text-white px-1 rounded">HOY</span>}</td>
                      <td className="p-2 text-right font-bold">{row.isWeekend ? '-' : money(row.expected)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    };

    const MetricsHeader = ({ sales, meta, businessData, onOpenPlanning }) => {
      const sold = sales.filter(s => s.estatus === 'Dispersado').reduce((acc, curr) => acc + (Number(curr.monto_dispersado) || 0), 0);
      const hotMoney = sales.filter(s => s.estatus === 'Acepta oferta' || s.estatus === 'Long track').reduce((acc, curr) => acc + (Number(curr.monto_preaprobado) || 0), 0);
      const deficit = sold - meta;
      const isDeficit = deficit < 0;

      return (
        <div className="bg-white p-3 shadow-sm border-b flex flex-wrap gap-6 items-center justify-between">
          <div className="flex gap-6 items-center flex-1">
             <div><p className="text-[10px] font-bold text-slate-400 uppercase">Real Dispersado</p><p className="text-2xl font-black text-slate-800">{money(sold)}</p></div>
             <div className="hidden md:block w-px h-10 bg-slate-200"></div>
             <div><p className="text-[10px] font-bold text-slate-400 uppercase">Diferencia vs Meta</p><p className={`font-bold text-xl ${isDeficit ? 'text-red-600' : 'text-green-600'}`}>{isDeficit ? '' : '+'}{money(deficit)}</p></div>
             <div className="hidden md:block w-px h-10 bg-slate-200"></div>
             <div className="hidden md:block"><p className="text-[10px] font-bold text-purple-500 uppercase flex items-center gap-1"><i className="fas fa-fire"></i> Potencial "Caliente"</p><p className="text-xl font-bold text-purple-700">{money(hotMoney)}</p></div>
             <div className="hidden md:block w-px h-10 bg-slate-200"></div>
             <div className="hidden md:block"><p className="text-[10px] font-bold text-slate-400 uppercase">Tiempo Restante</p><p className="text-xl font-bold text-slate-700">{businessData.remainingDays} días</p></div>
          </div>
          <button onClick={onOpenPlanning} className="bg-slate-800 text-white px-4 py-2 rounded text-xs font-bold hover:bg-slate-700 shadow-lg">
            <i className="fas fa-chart-pie mr-2"></i>Planificación
          </button>
        </div>
      );
    };

    const SaleCard = ({ sale, updateSale, deleteSale }) => {
      const [showDisburseModal, setShowDisburseModal] = useState(false);
      const [showDeleteModal, setShowDeleteModal] = useState(false);
      const [realAmount, setRealAmount] = useState(sale.monto_preaprobado);
      const [pin, setPin] = useState('');
      const [showHistory, setShowHistory] = useState(false);
      const [comment, setComment] = useState('');

      const handleStatusChange = (e) => {
        const newStatus = e.target.value;
        if (newStatus === 'Dispersado') {
           setRealAmount(sale.monto_preaprobado); setShowDisburseModal(true);
        } else {
           updateSale(sale.id, { estatus: newStatus, history: firebase.firestore.FieldValue.arrayUnion({ date: new Date().toISOString(), action: `Estatus: ${newStatus}`, user: 'Agente' }) });
        }
      };

      const addComment = (e) => {
        e.preventDefault();
        if(!comment.trim()) return;
        updateSale(sale.id, { history: firebase.firestore.FieldValue.arrayUnion({ date: new Date().toISOString(), action: `Nota: ${comment}`, user: 'Agente' }) });
        setComment('');
      };

      const confirmDisbursement = () => {
         updateSale(sale.id, { estatus: 'Dispersado', monto_dispersado: Number(realAmount), fecha_dispersion: new Date().toISOString(), history: firebase.firestore.FieldValue.arrayUnion({ date: new Date().toISOString(), action: `DISPERSADO: ${money(realAmount)}`, user: 'Agente' }) });
         setShowDisburseModal(false);
      };

      return (
        <div className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 mb-2 relative group hover:shadow-md transition-all">
          <div className={`absolute left-0 top-0 bottom-0 w-1 rounded-l-lg ${sale.estatus === 'Dispersado' ? 'bg-green-500' : 'bg-blue-500'}`}></div>
          <div className="pl-2">
            <div className="flex justify-between items-start">
              <span className="text-[10px] text-slate-400 font-mono">{sale.folio}</span>
              <button onClick={() => setShowDeleteModal(true)} className="text-slate-300 hover:text-red-500 px-2"><i className="fas fa-trash-alt text-xs"></i></button>
            </div>
            <h3 className="font-bold text-sm text-slate-800 truncate">{sale.nombre_cliente}</h3>
            
            <div className="flex justify-between items-end mt-1">
               <div className="flex flex-col"><span className="text-[10px] text-slate-400">Preaprobado</span><span className="font-bold text-slate-600 text-xs">{money(sale.monto_preaprobado)}</span></div>
               {sale.estatus === 'Dispersado' && (<div className="flex flex-col text-right"><span className="text-[10px] text-green-600 font-bold">DISPERSADO</span><span className="font-bold text-green-700 text-sm">{money(sale.monto_dispersado)}</span></div>)}
            </div>
            
            <div className="mt-2 flex flex-wrap gap-1 border-t border-slate-100 pt-2 items-center">
               {/* Teléfono modificado para solo mostrar el registro visible */}
               {sale.telefono && (
                 <span className="px-1.5 py-0.5 rounded bg-slate-50 border border-slate-100 text-slate-500 text-[10px] flex items-center font-medium">
                   <i className="fas fa-phone mr-1"></i> {sale.telefono}
                 </span>
               )}
               {sale.url && <a href={sale.url} target="_blank" className="w-5 h-5 rounded bg-slate-50 flex items-center justify-center text-slate-400 hover:text-blue-600 border border-slate-100"><i className="fas fa-link text-[10px]"></i></a>}
               <button onClick={() => setShowHistory(!showHistory)} className="ml-auto text-[10px] text-blue-500 underline">{showHistory ? 'Ocultar' : 'Bitácora'}</button>
            </div>
            
            {showHistory && (
              <div className="bg-slate-50 p-2 mt-2 rounded text-[10px]">
                 <div className="max-h-24 overflow-y-auto pr-1">
                   {sale.history && sale.history.slice().reverse().map((h, i) => (
                     <div key={i} className="border-b border-slate-200 pb-1 mb-1"><span className="font-bold text-slate-500 block">{formatDate(h.date)}</span><span className="break-words">{h.action}</span></div>
                   ))}
                 </div>
                 <form onSubmit={addComment} className="flex gap-1 mt-2 border-t border-slate-200 pt-2">
                   <input type="text" value={comment} onChange={(e) => setComment(e.target.value)} placeholder="Comentar..." className="flex-1 border border-slate-300 rounded px-1.5 py-1 text-xs outline-none" />
                   <button type="submit" className="bg-blue-600 text-white px-2 rounded"><i className="fas fa-paper-plane"></i></button>
                 </form>
              </div>
            )}
            <select value={sale.estatus} onChange={handleStatusChange} className="mt-2 w-full text-xs bg-slate-50 border border-slate-200 rounded p-1 outline-none focus:border-blue-500 cursor-pointer">
               {PIPELINE_STATUSES.map(s => (<option key={s} value={s}>{s}</option>))}
            </select>
          </div>

          {showDisburseModal && (
            <div className="fixed inset-0 glass-modal z-50 flex items-center justify-center p-4">
              <div className="bg-white p-5 rounded-lg shadow-xl w-full max-w-sm">
                <h3 className="font-bold text-lg mb-2 text-green-700">Confirmar Dispersión</h3>
                <input type="number" value={realAmount} onChange={(e) => setRealAmount(e.target.value)} className="w-full border-2 border-green-500 rounded p-2 text-xl font-bold mb-4" autoFocus />
                <div className="flex gap-2"><button onClick={confirmDisbursement} className="flex-1 bg-green-600 text-white py-2 rounded font-bold">Confirmar</button><button onClick={() => setShowDisburseModal(false)} className="flex-1 bg-slate-200 py-2 rounded font-bold">Cancelar</button></div>
              </div>
            </div>
          )}

          {showDeleteModal && (
            <div className="fixed inset-0 glass-modal z-50 flex items-center justify-center p-4">
              <div className="bg-white p-5 rounded-lg shadow-xl w-full max-w-sm border-2 border-red-100">
                <h3 className="font-bold text-lg mb-2 text-red-600">Eliminar Registro</h3>
                <input type="password" placeholder="PIN" value={pin} onChange={(e) => setPin(e.target.value)} className="w-full border p-2 rounded mb-2 text-center" />
                <div className="flex gap-2"><button onClick={() => { if(pin === '2398') deleteSale(sale.id); }} className="flex-1 bg-red-600 text-white py-2 rounded font-bold">ELIMINAR</button><button onClick={() => {setShowDeleteModal(false); setPin('');}} className="flex-1 bg-slate-200 py-2 rounded font-bold">Cancelar</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const App = ({ user }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [currentQuincena, setCurrentQuincena] = useState(new Date().getDate() <= 15 ? 1 : 2);
      
      const [allSales, setAllSales] = useState([]);
      const [metaQuincenal, setMetaQuincenal] = useState(0);
      const [isPlanningOpen, setIsPlanningOpen] = useState(false);
      const [showForm, setShowForm] = useState(false);

      const periodKey = `${user.uid}_${currentDate.getFullYear()}-${currentDate.getMonth()}-${currentQuincena}`;

      useEffect(() => {
        const unsub = db.collection('sales')
          .where('userId', '==', user.uid)
          .onSnapshot(snap => {
             const docs = snap.docs.map(d => ({id: d.id, ...d.data()}));
             docs.sort((a, b) => parseDate(b.fecha).getTime() - parseDate(a.fecha).getTime());
             setAllSales(docs);
          });
        return () => unsub();
      }, [user.uid]);

      useEffect(() => {
        const unsub = db.collection('metas').doc(periodKey).onSnapshot(doc => {
            if(doc.exists) setMetaQuincenal(doc.data().monto);
            else setMetaQuincenal(0);
        });
        return () => unsub();
      }, [periodKey]);

      const saveMeta = (amount) => db.collection('metas').doc(periodKey).set({ monto: amount, userId: user.uid }, { merge: true });

      const filteredSales = useMemo(() => {
        return allSales.filter(sale => {
          if(!sale.fecha) return false;
          const d = parseDate(sale.fecha);
          return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear() && getQuincena(d) === currentQuincena;
        });
      }, [allSales, currentDate, currentQuincena]);

      const businessData = getBusinessDaysQuincena(currentDate, currentQuincena);

      const handleAddSale = async (e) => {
        e.preventDefault();
        const form = e.target;
        await db.collection('sales').add({
          userId: user.uid, 
          folio: form.folio.value, // Registro manual del folio
          nombre_cliente: form.client.value,
          monto_preaprobado: Number(form.amount.value),
          monto_dispersado: 0,
          estatus: 'Con oferta',
          telefono: form.phone.value,
          url: form.url.value,
          fecha: new Date().toISOString(), 
          history: [{ date: new Date().toISOString(), action: 'Lead Creado', user: 'Agente' }]
        });
        setShowForm(false);
      };

      const handleUpdateSale = (id, data) => db.collection('sales').doc(id).update(data);
      const handleDeleteSale = (id) => db.collection('sales').doc(id).delete();

      const changePeriod = (dir) => {
        if(dir === 1) { if(currentQuincena === 1) setCurrentQuincena(2); else { setCurrentQuincena(1); setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1))); } } 
        else { if(currentQuincena === 2) setCurrentQuincena(1); else { setCurrentQuincena(2); setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1))); } }
      };

      return (
        <div className="flex flex-col h-full bg-slate-100">
          <div className="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md z-10">
            <div className="flex items-center gap-2 md:gap-4">
              <div className="flex flex-col hidden md:flex">
                 <h1 className="font-bold text-lg leading-tight">CRM</h1>
                 <span className="text-[10px] text-blue-400">{user.email ? user.email.split('@')[0] : 'Usuario'}</span>
              </div>
              <div className="flex items-center bg-slate-800 rounded px-1">
                <button onClick={() => changePeriod(-1)} className="p-2 hover:text-green-400"><i className="fas fa-chevron-left"></i></button>
                <div className="flex flex-col items-center w-40">
                    <span className="text-xs font-bold uppercase tracking-wider text-slate-400">{new Intl.DateTimeFormat('es-MX', { month: 'long', year: 'numeric' }).format(currentDate)}</span>
                    <span className="text-sm font-black text-green-400">Q{currentQuincena}</span>
                </div>
                <button onClick={() => changePeriod(1)} className="p-2 hover:text-green-400"><i className="fas fa-chevron-right"></i></button>
              </div>
            </div>
            
            <div className="flex gap-2 items-center">
              <a href="reports.html" className="bg-blue-600 px-3 py-1.5 rounded text-sm font-bold hover:bg-blue-500 shadow-lg text-white"><i className="fas fa-table md:mr-2"></i><span className="hidden md:inline">Reportes</span></a>
              <button onClick={() => setShowForm(true)} className="bg-green-600 px-3 py-1.5 rounded text-sm font-bold hover:bg-green-500 shadow-lg"><i className="fas fa-plus md:mr-2"></i><span className="hidden md:inline">Lead</span></button>
              <button onClick={() => auth.signOut()} className="text-slate-400 hover:text-white px-2" title="Cerrar sesión"><i className="fas fa-sign-out-alt"></i></button>
            </div>
          </div>

          <MetricsHeader sales={filteredSales} meta={metaQuincenal} businessData={businessData} onOpenPlanning={() => setIsPlanningOpen(true)} />

          <div className="flex-1 overflow-x-auto p-4 flex gap-4 pipeline-scroll items-start">
             {PIPELINE_STATUSES.map(status => (
               <div key={status} className="min-w-[280px] w-[280px] flex flex-col h-full bg-slate-200/60 rounded-xl pipeline-col border border-slate-300">
                 <div className="p-3 font-bold text-slate-600 text-sm flex justify-between bg-slate-100 rounded-t-xl border-b border-slate-200">{status}<span className="bg-white px-2 rounded-full text-xs shadow-sm">{filteredSales.filter(s => s.estatus === status).length}</span></div>
                 <div className="flex-1 overflow-y-auto p-2">
                   {filteredSales.filter(s => s.estatus === status).map(sale => <SaleCard key={sale.id} sale={sale} updateSale={handleUpdateSale} deleteSale={handleDeleteSale} />)}
                 </div>
               </div>
             ))}
          </div>

          {/* FORMULARIO MODIFICADO */}
          {showForm && (
            <div className="fixed inset-0 glass-modal z-50 flex items-center justify-center p-4">
              <form onSubmit={handleAddSale} className="bg-white rounded-lg shadow-xl w-full max-w-sm p-5 space-y-4">
                 <h2 className="font-bold text-lg">Nuevo Lead</h2>
                 <input name="folio" required placeholder="Número de Folio" className="w-full border p-2 rounded focus:outline-none focus:border-blue-500" />
                 <input name="client" required placeholder="Nombre Cliente" className="w-full border p-2 rounded focus:outline-none focus:border-blue-500" />
                 <input name="amount" type="number" required placeholder="Monto Preaprobado ($)" className="w-full border p-2 rounded focus:outline-none focus:border-blue-500" />
                 <input name="phone" placeholder="Teléfono" className="w-full border p-2 rounded focus:outline-none focus:border-blue-500" />
                 <input name="url" placeholder="Enlace / Link" className="w-full border p-2 rounded focus:outline-none focus:border-blue-500" />
                 <div className="flex gap-2 pt-2"><button type="submit" className="flex-1 bg-green-600 text-white py-2 rounded font-bold">Crear</button><button type="button" onClick={() => setShowForm(false)} className="flex-1 bg-slate-200 py-2 rounded font-bold">Cancelar</button></div>
              </form>
            </div>
          )}

          <PlanningModal isOpen={isPlanningOpen} onClose={() => setIsPlanningOpen(false)} meta={metaQuincenal} setMeta={saveMeta} businessData={businessData} year={currentDate.getFullYear()} month={currentDate.getMonth()} quincena={currentQuincena} />
        </div>
      );
    };

    const MainWrapper = () => {
      const [user, setUser] = useState(null);
      const [loadingAuth, setLoadingAuth] = useState(true);

      useEffect(() => {
        return auth.onAuthStateChanged((u) => {
          setUser(u);
          setLoadingAuth(false);
        });
      }, []);

      if (loadingAuth) return (
        <div className="h-screen bg-slate-900 flex flex-col justify-center items-center text-white">
          <div className="loader mb-4"></div>
          <p className="font-bold text-slate-400">Verificando seguridad...</p>
        </div>
      );
      
      if (!user) return <Login />;
      return <App user={user} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MainWrapper />);
  </script>
</body>
</html>
 
